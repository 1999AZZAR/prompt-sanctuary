{% extends "base.html" %}

{% block content %}
    <!-- Hero Section -->
    <div class="hero text-center mb-12 cursor-pointer" onclick="toggleSidePanel()">
        <h1 class="text-5xl font-bold mb-4">Community Prompt(s)</h1>
        <p class="text-lg text-gray-300">Explore prompts shared by the community.</p>
    </div>

    <!-- Search Bar -->
    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl mb-8">
        <h2 class="text-2xl font-bold mb-6">Search Prompts</h2>
        <input type="text" id="searchInput" placeholder="Search prompts..." class="w-full p-3 bg-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>

    <!-- Combined Prompts Section -->
    <div class="glass p-8 mb-8">
        <h2 class="mdc-typography--headline5 mb-6">All Prompts</h2>
        <div class="mdc-layout-grid">
            <div class="mdc-layout-grid__inner" id="allPrompts">
                {% for prompt in system_prompts %}
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-6-tablet mdc-layout-grid__cell--span-4-desktop">
                    <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto">
                        <div class="mdc-card__primary-action" tabindex="0">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="mdc-typography--headline6">{{ prompt[2] }}</h4>
                                <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">Default</span></span>
                            </div>
                            <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">{{ prompt[3] | safe }}</p>
                        </div>
                        <div class="mdc-card__actions">
                            <div class="mdc-card__action-buttons">
                                <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="{{ prompt[3] | e }}">Copy</button>
                                <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="{{ prompt[2] | e }}" data-prompt="{{ prompt[3] | e }}">Save</button>
                                <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="{{ prompt[2] | e }}" data-content="{{ prompt[3] | e }}">See</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% for prompt in shared_prompts %}
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-6-tablet mdc-layout-grid__cell--span-4-desktop">
                    <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto">
                        <div class="mdc-card__primary-action" tabindex="0">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="mdc-typography--headline6">{{ prompt[2] }}</h4>
                                <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">Shared</span></span>
                            </div>
                            <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">{{ prompt[3] | safe }}</p>
                        </div>
                        <div class="mdc-card__actions">
                            <div class="mdc-card__action-buttons">
                                <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="{{ prompt[3] | e }}">Copy</button>
                                <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="{{ prompt[2] | e }}" data-prompt="{{ prompt[3] | e }}">Save</button>
                                {% if prompt[0] == session['username'] %}
                                <button class="text-red-400 hover:text-red-300 mdc-button mdc-button--text unshare-button" data-prompt-id="{{ prompt[1] }}">Unshare</button>
                                {% endif %}
                                <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="{{ prompt[2] | e }}" data-content="{{ prompt[3] | e }}">See</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- JavaScript for Sidebar Behavior -->
    <script defer src="{{ url_for('static', filename='script/community.js') }}"></script>

    <!-- JavaScript for Fuzzy Search -->
    <script>
        // Initialize Fuse.js for fuzzy search
        const allPrompts = [
            {% for prompt in system_prompts %}
            { title: {{ prompt[2] | tojson }}, content: {{ prompt[3] | tojson }}, type: 'default' },
            {% endfor %}
            {% for prompt in shared_prompts %}
            { title: {{ prompt[2] | tojson }}, content: {{ prompt[3] | tojson }}, type: 'shared', id: {{ prompt[1] | tojson }} },
            {% endfor %}
        ];

        const fuseOptions = {
            keys: ['title', 'content'],
            threshold: 0.3, // Adjust sensitivity of search
        };

        const fuse = new Fuse(allPrompts, fuseOptions);

        // Function to render all prompts
        function renderAllPrompts() {
            const allContainer = document.getElementById('allPrompts');

            // Render all prompts
            allContainer.innerHTML = allPrompts.map(prompt => `
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-6-tablet mdc-layout-grid__cell--span-4-desktop">
                    <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto">
                        <div class="mdc-card__primary-action" tabindex="0">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="mdc-typography--headline6">${prompt.title}</h4>
                                <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">${prompt.type === 'default' ? 'Default' : 'Shared'}</span></span>
                            </div>
                            <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">${escapeHtml(prompt.content)}</p>
                        </div>
                        <div class="mdc-card__actions">
                            <div class="mdc-card__action-buttons">
                                <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="${escapeHtml(prompt.content)}">Copy</button>
                                <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="${escapeHtml(prompt.title)}" data-prompt="${escapeHtml(prompt.content)}">Save</button>
                                ${prompt.type === 'shared' ? `<button class="text-red-400 hover:text-red-300 mdc-button mdc-button--text unshare-button" data-prompt-id="${prompt.id}">Unshare</button>` : ''}
                                <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="${escapeHtml(prompt.title)}" data-content="${escapeHtml(prompt.content)}">See</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Re-attach event listeners after rendering
            reattachEventListeners();
        }

        // Escape HTML special chars for safe attribute values and content
        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        // Search function
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const query = e.target.value.trim();

            if (query === "") {
                // If search input is empty, render all prompts
                renderAllPrompts();
            } else {
                // Perform fuzzy search
                const results = fuse.search(query);

                // Update all prompts
                const allContainer = document.getElementById('allPrompts');
                allContainer.innerHTML = results.map(result => `
                    <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-6-tablet mdc-layout-grid__cell--span-4-desktop">
                        <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto">
                            <div class="mdc-card__primary-action" tabindex="0">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="mdc-typography--headline6">${result.item.title}</h4>
                                    <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">${result.item.type === 'default' ? 'Default' : 'Shared'}</span></span>
                                </div>
                                <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">${escapeHtml(result.item.content)}</p>
                            </div>
                            <div class="mdc-card__actions">
                                <div class="mdc-card__action-buttons">
                                    <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="${escapeHtml(result.item.content)}">Copy</button>
                                    <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="${escapeHtml(result.item.title)}" data-prompt="${escapeHtml(result.item.content)}">Save</button>
                                    ${result.item.type === 'shared' ? `<button class="text-red-400 hover:text-red-300 mdc-button mdc-button--text unshare-button" data-prompt-id="${result.item.id}">Unshare</button>` : ''}
                                    <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="${escapeHtml(result.item.title)}" data-content="${escapeHtml(result.item.content)}">See</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Re-attach event listeners after rendering search results
                reattachEventListeners();
            }
        });

        // Render all prompts on page load
        renderAllPrompts();
    </script>

{% endblock %}
