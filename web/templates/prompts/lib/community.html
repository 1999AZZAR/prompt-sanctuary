{% extends "base.html" %}

{% block content %}
    <!-- Hero Section -->
    <div class="hero text-center mb-12 cursor-pointer" onclick="toggleSidePanel()" role="region" aria-labelledby="community-page-heading">
        <h1 id="community-page-heading" class="text-5xl font-bold mb-4"><i class="fas fa-users mr-2"></i>Community Prompt(s)</h1>
        <p class="text-lg text-gray-300">Explore prompts shared by the community.</p>
    </div>

    <!-- Search Bar -->
    <h2 id="search-prompts-heading" class="text-2xl font-bold mb-6">Search Prompts</h2>
    <div class="search-container mb-6" role="search">
    <input type="text" id="searchInput" placeholder="Search prompts..." class="w-full p-3 bg-gray-700 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Search community prompts">
        <button id="clearSearchBtn" class="clear-search-btn hidden" aria-label="Clear search">&times;</button>
    </div>

    <!-- Combined Prompts Section -->
    <div class="mdc-layout-grid" role="region" aria-labelledby="search-prompts-heading">
        <div class="mdc-layout-grid__inner" id="allPrompts">
            {% for prompt in system_prompts %}
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-6-desktop">
                <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto" role="article" aria-labelledby="prompt-title-{{ loop.index0 }}-default">
                    <div class="mdc-card__primary-action" tabindex="0">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="mdc-typography--headline6" id="prompt-title-{{ loop.index0 }}-default">{{ prompt[2] }}</h4>
                            <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">Default</span></span>
                        </div>
                        <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">{{ prompt[3] | safe }}</p>
                    </div>
                    <div class="mdc-card__actions">
                        <div class="mdc-card__action-buttons">
                            <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="{{ prompt[3] | e }}" aria-label="Copy prompt: {{ prompt[2] | e }}">Copy</button>
                            <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="{{ prompt[2] | e }}" data-prompt="{{ prompt[3] | e }}" aria-label="Save prompt: {{ prompt[2] | e }}">Save</button>
                            <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="{{ prompt[2] | e }}" data-content="{{ prompt[3] | e }}" aria-label="See details for prompt: {{ prompt[2] | e }}">See</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% for prompt in shared_prompts %}
            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-6-desktop">
                <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto" role="article" aria-labelledby="prompt-title-{{ loop.index0 }}-shared">
                    <div class="mdc-card__primary-action" tabindex="0">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="mdc-typography--headline6" id="prompt-title-{{ loop.index0 }}-shared">{{ prompt[2] }}</h4>
                            <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">Shared</span></span>
                        </div>
                        <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">{{ prompt[3] | safe }}</p>
                    </div>
                    <div class="mdc-card__actions">
                        <div class="mdc-card__action-buttons">
                            <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="{{ prompt[3] | e }}" aria-label="Copy prompt: {{ prompt[2] | e }}">Copy</button>
                            <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="{{ prompt[2] | e }}" data-prompt="{{ prompt[3] | e }}" aria-label="Save prompt: {{ prompt[2] | e }}">Save</button>
                            {% if prompt[0] == session['username'] %}
                            <button class="text-red-400 hover:text-red-300 mdc-button mdc-button--text unshare-button" data-prompt-id="{{ prompt[1] }}" aria-label="Unshare your prompt: {{ prompt[2] | e }}">Unshare</button>
                            {% endif %}
                            <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="{{ prompt[2] | e }}" data-content="{{ prompt[3] | e }}" aria-label="See details for prompt: {{ prompt[2] | e }}">See</button>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- JavaScript for Sidebar Behavior -->
    <script defer src="{{ url_for('static', filename='script/community.js') }}"></script>

    <!-- JavaScript for Fuzzy Search -->
    <script>
        // Initialize Fuse.js for fuzzy search
        const allPrompts = [
            {% for prompt in system_prompts %}
            { id: 'default-{{ loop.index0 }}', title: {{ prompt[2] | tojson }}, content: {{ prompt[3] | tojson }}, type: 'default' },
            {% endfor %}
            {% for prompt in shared_prompts %}
            { id: 'shared-{{ loop.index0 }}', title: {{ prompt[2] | tojson }}, content: {{ prompt[3] | tojson }}, type: 'shared', prompt_id_val: {{ prompt[1] | tojson }}, username: {{ prompt[0] | tojson }} },
            {% endfor %}
        ];

        const fuseOptions = {
            keys: ['title', 'content'],
            threshold: 0.3, // Adjust sensitivity of search
        };

        const fuse = new Fuse(allPrompts, fuseOptions);

        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const allPromptsContainer = document.getElementById('allPrompts');

        // Function to render all prompts
        function renderAllPrompts(promptsToRender = allPrompts) {
            const currentUsername = "{{ session.username }}"; // Get current username from session
            allPromptsContainer.innerHTML = promptsToRender.map((prompt, index) => {
                const uniqueId = prompt.id || `${prompt.type}-${index}`;
                let unshareButtonHtml = '';
                if (prompt.type === 'shared' && prompt.username === currentUsername) {
                    unshareButtonHtml = `<button class="text-red-400 hover:text-red-300 mdc-button mdc-button--text unshare-button" data-prompt-id="${escapeHtml(prompt.prompt_id_val)}" aria-label="Unshare your prompt: ${escapeHtml(prompt.title)}">Unshare</button>`;
                }

                return `
                <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12 mdc-layout-grid__cell--span-4-tablet mdc-layout-grid__cell--span-6-desktop">
                    <div class="mdc-card glass prompt-card p-6 flex flex-col justify-between max-h-64 overflow-y-auto" role="article" aria-labelledby="prompt-title-${uniqueId}">
                        <div class="mdc-card__primary-action" tabindex="0">
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="mdc-typography--headline6" id="prompt-title-${uniqueId}">${escapeHtml(prompt.title)}</h4>
                                <span class="mdc-chip mdc-chip--outlined"><span class="mdc-chip__text">${prompt.type === 'default' ? 'Default' : 'Shared'}</span></span>
                            </div>
                            <p class="mdc-typography--body2 mb-6 whitespace-pre-wrap break-words">${escapeHtml(prompt.content)}</p>
                        </div>
                        <div class="mdc-card__actions">
                            <div class="mdc-card__action-buttons">
                                <button class="text-blue-400 hover:text-blue-300 mdc-button mdc-button--text copy-button" data-clipboard-text="${escapeHtml(prompt.content)}" aria-label="Copy prompt: ${escapeHtml(prompt.title)}">Copy</button>
                                <button class="text-green-400 hover:text-green-300 mdc-button mdc-button--text save-button" data-title="${escapeHtml(prompt.title)}" data-prompt="${escapeHtml(prompt.content)}" aria-label="Save prompt: ${escapeHtml(prompt.title)}">Save</button>
                                ${unshareButtonHtml}
                                <button class="text-indigo-400 hover:text-indigo-300 mdc-button mdc-button--text see-button" data-title="${escapeHtml(prompt.title)}" data-content="${escapeHtml(prompt.content)}" aria-label="See details for prompt: ${escapeHtml(prompt.title)}">See</button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');

            // Re-attach event listeners after rendering
            reattachEventListeners();
        }

        // Escape HTML special chars for safe attribute values and content
        function escapeHtml(str) {
            if (typeof str !== 'string') return '';
            return str.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;')
                      .replace(/"/g, '&quot;')
                      .replace(/'/g, '&#039;');
        }

        // Debounce function
        function debounce(func, delay) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        // Search function (debounced)
        searchInput.addEventListener('input', debounce((e) => {
            const query = e.target.value.trim();
            clearSearchBtn.classList.toggle('hidden', query === "");

            if (query === "") {
                renderAllPrompts();
            } else {
                const results = fuse.search(query);
                renderAllPrompts(results.map(r => r.item));
            }
        }, 300)); // Adjusted debounce to 300ms

        clearSearchBtn.addEventListener('click', () => {
            searchInput.value = "";
            renderAllPrompts();
            clearSearchBtn.classList.add('hidden');
            searchInput.focus(); // Optional: refocus the input
        });

        // Initial state for clear button
        clearSearchBtn.classList.toggle('hidden', searchInput.value.trim() === "");

        // Render all prompts on page load
        renderAllPrompts();
    </script>

{% endblock %}
